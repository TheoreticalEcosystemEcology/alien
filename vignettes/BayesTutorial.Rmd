---
title: "Bayesian Models in Species Interactions"
author: "Ben Weinstein"
date: "December 2, 2016"
output: html_document
---

#Aim
A short tutorial explaining the different options for fitting hierarchical bayesian models for species interactions using the package alienR

```{r,message=F,warning=F}
library(alienR)
library(ggplot2)
library(knitr)
library(dplyr)
opts_chunk$set(warning=F,message=F)
```

# Simulate data

For this example, let's similiar some interaction data on trait-matching among species

```{r}
dat<-sim.traitmatch(size_x = 8,size_y = 9,traits_x = rpois(8,7),traits_y = rpois(9,10),alpha_sigma = 3,replicates=5)
```

We can view the trait-matching in this simulated dataset

```{r}
ggplot(dat,aes(x=abs(TraitI-TraitJ),y=Interactions)) + geom_point() + geom_smooth(method="glm",method.args=list(family="binomial")) + ggtitle("Pairwise Trait-matching") + labs(y="Prob. of Interaction")
```

#Intercept Model
We can then fit a hierarchical bayesian model. The simplest model is an intercept model, such that the probability of interaction is fixed for each pair of species.

```{r}
intercept<-fit.bayesreg(dat = dat,algorithm = "Intercept",draws=10000)
```

Get the matrix of probability of interactions among observed species. Since this is the intercept model, we are just interested in the probabilities of our observed matrix. This is the default of the predict function.

```{r}
predframe<-predict.bayesreg(intercept)

#summarize mean, lower 5th and upper 9th
sumframe<-predframe %>% group_by(I,J) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))
```

##View interactions
```{r}
ggplot(sumframe,aes(x=as.factor(I),y=J,fill=mean)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

But wait, there's more! Since we fit the model using MCMC, we have built in estimates in the uncertainty in species interactions.

Upper 95th estimate
```{r}
ggplot(sumframe,aes(x=as.factor(I),y=J,fill=upper)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

Lower 5th estimate
```{r}
ggplot(sumframe,aes(x=as.factor(I),y=J,fill=lower)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

If we want the distributions, instead of a summary we can plot the posterior predictions directly. For the sake of plotting, lets look at just one node.

```{r}
justB<-predframe %>% filter(I=="b") 
ggplot(data=justB,aes(x=J,y=value)) + geom_boxplot() + labs(y="Probability of interaction") + ggtitle("For Species B in the higher level") + theme_bw()
```

# Binomial Model

An intercept model may work well in some situations, but we often are collecting data to test some underlying ecological mechansim. For example, to test trait-matching among network partners. IN the intercept model, we never used the trait values we simulated. Let's correct that.

```{r}
binomial<-fit.bayesreg(dat=dat,algorithm = "Binomial",draws=10000)
```

Just as before, we can get the predicted matrix based on the model fit.

```{r}
predframe2<-predict.bayesreg(binomial)

#summarize mean, lower 5th and upper 9th
sumframe2<-predframe2 %>% group_by(I,J) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95),Traitmatch=unique(Traitmatch))
```

##View interactions
```{r}
ggplot(sumframe2,aes(x=as.factor(I),y=J,fill=mean)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

Upper 95th estimate
```{r}
ggplot(sumframe2,aes(x=as.factor(I),y=J,fill=upper)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

Lower 5th estimate
```{r}
ggplot(sumframe2,aes(x=as.factor(I),y=J,fill=lower)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

Create the same boxplot as in the intercept model

```{r}
justB2<-predframe2 %>% filter(I=="b") 
ggplot(data=justB,aes(x=J,y=value)) + geom_boxplot(fill="black") + labs(y="Probability of interaction") + ggtitle("For Species B in the higher level") + theme_bw()
```

Notice that as we added information the confidence intervals greatly decreased.

## View trait-matching function

```{r}
ggplot(sumframe2,aes(x=Traitmatch,y=mean,ymin=lower,ymax=upper)) + geom_line() + geom_ribbon(alpha=0.7,fill="black") + labs(y="Probability of Interaction") + theme_bw()
```

# Multinomial Model

Several different papers have been interested in assigning probability to each pair of interactions based on a multinomial or direchlet distribution. 

```{r}
multinomial<-fit.bayesreg(dat,algorithm = "Multinomial")
```

Plot multinomial probabilities. Let's extract the model output directly.

```{r}
#extract pars
predframe3<-predict.bayesreg(multinomial)
```

Remember that a multinomial draw is similiar to our intercept model, each pairwise interaction gets a seperate probability. 

## Mean Interaction Probabilities
```{r}
sumframe3<-predframe3 %>% group_by(I,J) %>%  summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) 

m_mean<-ggplot(sumframe3,aes(x=as.factor(I),y=J,fill=upper)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + labs(x="I")
```

Using species B from the upper level, as in the previous two models, as a visual.

```{r}
justB3<-predframe3 %>% filter(I=="b") 
ggplot(data=justB,aes(x=J,y=value)) + geom_boxplot() + labs(y="Probability of interaction") + ggtitle("For Species B in the higher level") + theme_bw()
```

#Compare probabilities

```{r}
sumframe$Model<-"Intercept"
sumframe2$Model<-"Binomial"
sumframe3$Model<-"Multinomial"

allsums<-bind_rows(list(sumframe,sumframe2,sumframe3))

#side by side comparison of mean probabilites
ggplot(allsums) + geom_tile(aes(x=I,y=J,fill=mean)) + facet_grid(~Model) + scale_fill_continuous(low="blue",high="red")
```

For our example species B

```{r}
justB$Model<-"Intercept"
justB2$Model<-"Binomial"
justB3$Model<-"Multinomial"

allB<-bind_rows(list(justB,justB2,justB3))
ggplot(data=allB,aes(x=J,y=value)) + geom_boxplot(aes(fill=Model)) + labs(y="Probability of interaction") + ggtitle("For Species B in the higher level") + theme_bw()
```

# Generate networks and statistics

One of the virtues of having a posterior distribution of interaction probabilities is that we can attach uncertainty to our predicted networks. By taking a binomial draw for each of our predicted interactions, we generate a binary network. From that binary network we can calculate our desired network statistics.

```{r}
intercept_stats<-network.bayesreg(predframe,indices=c("nestedness","connectance"))
intercept_stats$Model<-"Intercept"
binomial_stats<-network.bayesreg(predframe2,indices=c("nestedness","connectance"))
binomial_stats$Model<-"Binomial"

allstats<-rbind_all(list(intercept_stats,binomial_stats))

#plot distribution fo variables
ggplot(allstats,aes(x=nstat)) + geom_density(alpha=0.6,aes(fill=Model)) + facet_wrap(~Metric,scales='free',nrow=1) + theme_bw()  + labs(x="value")
```

Same data, different model, different network statistics! Models matter. My point here is not that one model performed 'better', since the data was simulated in a similiar way. More that the models are not interchangable, and must be validated on quantitative and philosophical grounds.

# Adding complexity.

Due to samplind constraints, it is usually impossible to fully monitor a network and resolve interactions among all species.

```{r}
occupancy<-fit.bayesreg(dat,algorithm = "Occupancy")
```
