---
title: "How to use itDNS"
author: "Kevin Cazelles and Steve Vissault"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# Load the *Bartomeus* dataset

```{r loadalien, echo=F}
devtools::load_all(".")
```

```{r loaddata}
library(magrittr)
data(bartomeus)
## Let's examine this alienData object:
names(bartomeus)
```

<!-- idp <- which(as.character(bartomeus$interactPair[,1]) == "Apis mellifera") -->

<!-- idp <- which(bartomeus$traitSp$traitName=="flower_morphology")
simpleNetwork(bartomeus$interactPair) -->


# Load the *Bartomeus* dataset

```{r fitDMC, results="hide"}
## GLM
mod1 <- fitDMC(bartomeus, class='glm', family=poisson(), level='species', step=TRUE)
## Random Forest
mod2 <- fitDMC(bartomeus, class='rf', level='species')
```

# Predictions

```{r predictDMC, results="hide"}
df0 <- reshape2::dcast(bartomeus$traitSp, idSp ~ traitName)
df <- df0[which(!is.na(df0$flower_morphology)),]
ida <- which(as.character(df0$idSp) == "Apis mellifera")
df$IT <- df0$IT[ida]
df$tongue_length <- df0$tongue_length[ida]
##
names(df)[2:6] %<>% paste0(".x")
names(df)[7:8] %<>% paste0(".y")
##
for (i in 2:3) df[,i] <- as.factor(df[,i])
for (i in 4:8) df[,i] <- as.numeric(df[,i])
##
res1 <- predict.glm(mod1, newdata = df)
res2 <- predict(mod2, newdata = df)
```




df <- readRDS("~/Dropbox/LetiR/bartom.Rds")
for (i in 6:10) df[,i] %<>% as.numeric
for (i in 1:2) df[,i] %<>% as.character

df_pred <- expand.grid(idTo = unique(df[,1]), idFrom = unique(df[,2]))
df_pred$visit <- 0
df_pred$I <- FALSE
df_pred$m2 <- df_pred$m1 <- NA
df_pred$c4 <- df_pred$c3 <- NA

pas <- paste0(df[,1L], df[,2L])

for (i in 1:nrow(df_pred)){
  idpo <- which(df_pred[i, 1L]==df$idTo)[1L]
  idpl <- which(df_pred[i, 2L]==df$idFrom)[1L]
  ##
  df_pred$m1[i] <- (df$nectar_tube_depth_mm.x[idpl] - df$tongue_length.y[idpo])^2
  ##
  df_pred$m2[i] <- (df$nectar_tube_diameter_mm.x[idpl] - df$IT.y[idpo])^2
  ##
  df_pred$c3[i] <- paste0(df$flower_morphology.x[idpl],df$flower_form.x[idpl])
  ##
  df_pred$c4[i] <- df$flower_width_mm.x[idpl]
  ##
  id <- which(paste0(df_pred[i, 1L],df_pred[i, 2L]) == pas)
  if (length(id)){
    df_pred$visit[i] <- df$I[id]
    df_pred$I[i] <- TRUE
  }
}








df <- readRDS("~/Dropbox/LetiR/bartom.Rds")
for (i in 6:10) df[,i] %<>% as.numeric
for (i in 1:2) df[,i] %<>% as.character

m1 <- (df[,7]-df[,10])^2
m2 <- (df[,"IT.y"]-df[,"flower_width_mm.x"])^2


df_ready <- cbind(
  df[,1:3],
  m1 = m1,
  m2 = m2,
  c3=paste0(df[,"flower_morphology.x"],df[,"flower_form.x"]),
  c4= df$flower_width_mm.x
  )
  <!-- c1=df[,"IT.y"], -->
  <!-- c2=df[,"flower_width_mm.x"], -->

fml <- "I~m1+m2+c3*c4"
mod1 <-  glm(as.formula(fml), data = df_ready, family = poisson) %>% step
idam <- which(as.character(df_pred$idTo) == "Apis mellifera")
newdf <- df_pred[idam, 4:7]
newdf$c3 %<>% as.factor
res <- data.frame(df_pred[idam, 1:4], predict=predict(mod1b, newdf))

res$obs <- 0
for (i in 1:nrow(res)){
  if res$obs[i] <-
}


graphi <- graph_from_data_frame(res)

png("~/Desktop/coolpred.png", width=7, height=7, unit="in", res=300)
coords <- layout_in_circle(graphi, 2:55)
par(mar=c(1,1,1,1))
plot0(c(-1.8,1.8), c(-1.5,1.5), asp=1)
plot(graphi,
    vertex.size = c(0,rep(10, 54)),
    edge.width = 2*log(res$predict+1),
    edge.arrow.size = 0,
    vertex.color = "#034370",
    vertex.frame.color= "white",
    layout = coords,
    vertex.label=NA,
    add=T
)


seqa <- seq(0,2*pi, length=55)[-55]
for (i in 1:54) text(1.1*cos(seqa[i]), 1.1*sin(seqa[i]), srt=180/pi*seqa[i]+180, labels=as.character(res$idFrom[i]), pos=2)
pchImage(0,0,file="~/Desktop/ApisMellifera.png", add=T, cex.y=1)

dev.off()


<!-- edge.width = 2*log(res$visit+1), -->




pchI  


<!-- ids <- which(df$nectar_tube_depth_mm.x>0)
mod1b <- glm(as.formula(fml), data = df_ready[ids,], family = poisson) %>% step

predict(mod1b)

which(df_pred$idFrom=="Apis mellifera")

mod2 <- randomForest(as.formula(fml), data = df_ready) -->



# Plot the results

Here we focus on *Apis mellifera*:

<!-- ```{r fitDMC, "}
library(igraph)
idp <- which(bartomeus$traitSp$traitName=="flower_morphology")
nms <- c(as.character(bartomeus$traitSp$idSp[idp]), "Apis mellifera")
ids <- which(rownames(bartomeus$interactSp)%in%nms)
graphi <- graph_from_adjacency_matrix(bartomeus$interactSp[ids,ids])
seqtyp <- rep(1, length(nms))
seqtyp[4] <- 2
# plot(graphi,
#   vertex.size =
#   layout = layout_in_circle(graphi, 2:55)))
``` -->


<!-- id <- which(bartomeus$traitSp$traitName=="flower_morphology")

bartomeus$idSp

plot.igraph(net,
   vertex.size = nodes$No.sources,
   vertex.color = as.factor(nodes$Type),
   vertex.frame.color= "black",
   vertex.label.color="black",
   edge.width = links$weight,
   edge.arrow.size = 1+10*log(links$weight/min(links$weight)),
   edge.color = factor(data.frame(from=links$from,
   Type=nodes[match(links$from, nodes$id),4])$Type,
   levels=levels(as.factor(nodes$Type))),
   vertex.label=NA, layout = coords, add=TRUE)
 # a loop is needed as 'srt' cannot be a vector....
 for (i in 1:length(seq.angle)) {
   text(x=title.coords[i,1], y=title.coords[i,2], nodes$Node.name[i],
   pos = title.pos[i], srt=title.angle[i], cex=0.9)
 } -->
